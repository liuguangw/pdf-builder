import {bookList} from "./book_list.js";
import {writeFile} from 'fs/promises';
import formatMenuList from "../lib/format_menu_list.js";

async function saveBookMenu(projectName, menuList) {
    let items = await bookList();
    let bookInfo = null;
    items.forEach(itemInfo => {
        if (itemInfo.projectName === projectName) {
            bookInfo = itemInfo
        }
    });
    if (bookInfo === null) {
        throw new Error("project " + projectName + " not found")
    }
    let menuHtml = formatMenuHtml(projectName, bookInfo.title, bookInfo.contextURL, menuList)
    let savePath = "./server/projects/" + projectName + "/dist/__entry.html"
    await writeFile(savePath, menuHtml)
}

function formatMenuHtml(projectName, bookTitle, contextURL, menuList) {
    let allGroupHtml = "<h1 class=\"book-main-title\">" + bookTitle + "</h1>\n" +
        "\t<div class=\"menu-list\">\n";
    allGroupHtml += formatMenuList(contextURL, menuList, 1)
    allGroupHtml += "\t</div>\n"
    return "<!DOCTYPE html>\n" +
        "<html lang=\"en\">\n" +
        "  <head>\n" +
        "    <meta charset=\"utf-8\" />\n" +
        "    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n" +
        "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\" />" +
        "    <title>" + bookTitle + "</title>\n" +
        "    <link rel=\"stylesheet\" href=\"../../../css/menu.css\" />" +
        "  </head>\n" +
        "  <body>\n" + allGroupHtml + "\n" +
        "<div class=\"menu-tip\" style=\"margin-left: 40px;\"><span>Generated by</span><a href=\"https://github.com/liuguangw/pdf-builder\">pdf-builder</a> </div>\n" +
        " </body>\n" +
        "</html>";
}

export default saveBookMenu
